name: Deploy (OIDC + JIT)

on:
  push:
    branches: [ main ]

# Permiss√µes necess√°rias para autentica√ß√£o OIDC com a AWS
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Get GitHub Runner IP
      id: ip
      run: echo "ipv4=$(curl -s https://api.ipify.org)" >> $GITHUB_OUTPUT

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v3
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    # --- NOVO STEP: Busca o IP P√∫blico atual da Inst√¢ncia ---
    - name: Get EC2 Public IP
      id: get_ec2_ip
      run: |
        # Busca o IP p√∫blico usando o ID da inst√¢ncia
        PUBLIC_IP=$(aws ec2 describe-instances \
          --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
          --query "Reservations[0].Instances[0].PublicIpAddress" \
          --output text)
        
        # Verifica se a inst√¢ncia est√° ligada e tem IP
        if [ "$PUBLIC_IP" == "None" ] || [ -z "$PUBLIC_IP" ]; then
          echo "‚ùå Erro: A inst√¢ncia parece estar desligada ou sem IP p√∫blico."
          exit 1
        fi
        
        # Salva o IP na vari√°vel de ambiente do GitHub Actions
        echo "EC2_HOST=$PUBLIC_IP" >> $GITHUB_ENV
        echo "‚úÖ IP Detectado: $PUBLIC_IP"

    - name: Open SSH Port (Port 22)
      run: |
        aws ec2 authorize-security-group-ingress \
          --group-id ${{ secrets.AWS_SG_ID }} \
          --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32

    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e
          cd /home/ubuntu/app
          
          echo "üöÄ Iniciando Deploy..."
          
          # Garante que o ambiente local do servidor esteja limpo e atualizado
          git fetch origin main
          git reset --hard origin/main
          
          # Atualiza depend√™ncias e banco de dados
          source venv/bin/activate
          pip install -r requirements.txt
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          
          # Reinicia o servi√ßo
          sudo systemctl restart gunicorn
          
          # Verifica se o Gunicorn subiu com sucesso
          if sudo systemctl is-active --quiet gunicorn; then
            echo "‚úÖ Deploy finalizado com sucesso e Gunicorn ativo!"
          else
            echo "‚ùå Erro: Gunicorn falhou ao iniciar!"
            exit 1
          fi

    - name: Close SSH Port (Always)
      if: always()
      run: |
        aws ec2 revoke-security-group-ingress \
          --group-id ${{ secrets.AWS_SG_ID }} \
          --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32
