name: Deploy (OIDC + JIT)

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Get GitHub Runner IP
      id: ip
      run: echo "ipv4=$(curl -s https://api.ipify.org)" >> $GITHUB_OUTPUT

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v3
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: Get EC2 Public IP
      id: get_ec2_ip
      run: |
        PUBLIC_IP=$(aws ec2 describe-instances \
          --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
          --query "Reservations[0].Instances[0].PublicIpAddress" \
          --output text)
        
        if [ "$PUBLIC_IP" == "None" ] || [ -z "$PUBLIC_IP" ]; then
          echo "❌ Erro: A instância parece estar desligada ou sem IP público."
          exit 1
        fi
        
        # Salva o IP na variável de ambiente (ENV)
        echo "EC2_HOST=$PUBLIC_IP" >> $GITHUB_ENV
        echo "✅ IP Detectado: $PUBLIC_IP"

    - name: Open SSH Port (Port 22)
      run: |
        aws ec2 authorize-security-group-ingress \
          --group-id ${{ secrets.AWS_SG_ID }} \
          --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32

    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        # Usando env.EC2_HOST em vez de secrets
        host: ${{ env.EC2_HOST }} 
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # Garante que o script é executável (segurança extra)
          chmod +x /home/ubuntu/deploy.sh
          
          # Executa o script de automação que criamos
          /home/ubuntu/deploy.sh

    - name: Close SSH Port (Always)
      if: always()
      run: |
        aws ec2 revoke-security-group-ingress \
          --group-id ${{ secrets.AWS_SG_ID }} \
          --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32