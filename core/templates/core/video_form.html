{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h3>Upload de V√≠deo (Direct to S3)</h3>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="titulo-id" class="form-label">T√≠tulo do V√≠deo</label>
                <input type="text" id="titulo-id" class="form-control" placeholder="Ex: Aula 01 - Introdu√ß√£o">
            </div>

            <div class="mb-3">
                <label for="video-file" class="form-label">Selecione o arquivo MP4</label>
                <input type="file" id="video-file" class="form-control" accept="video/mp4,video/x-m4v,video/*">
            </div>

            <button type="button" id="upload-btn" onclick="startDirectUpload()" class="btn btn-success">
                Fazer Upload
            </button>

            <div id="progress-container" class="mt-4" style="display:none;">
                <div class="progress" style="height: 25px;">
                    <div id="upload-progress" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%;">0%</div>
                </div>
                <p id="status-text" class="text-center mt-2 fw-bold text-primary">Iniciando...</p>
            </div>
            <hr class="my-5">
            <h4>√öltimos Uploads Realizados</h4>
            <table class="table table-striped mt-3">
                <thead>
                    <tr>
                        <th>T√≠tulo</th>
                        <th>Data</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="recent-uploads">
                    <tr><td colspan="3" class="text-center text-muted">Nenhum upload nesta sess√£o.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
async function startDirectUpload() {
    const fileInput = document.getElementById('video-file');
    const tituloInput = document.getElementById('titulo-id');
    const file = fileInput.files[0];
    const btn = document.getElementById('upload-btn');

    if (!file || !tituloInput.value) {
        return alert("Por favor, preencha o t√≠tulo e selecione um arquivo!");
    }

    // Bloquear bot√£o e mostrar progresso
    btn.disabled = true;
    document.getElementById('progress-container').style.display = 'block';
    const progressBar = document.getElementById('upload-progress');
    const statusText = document.getElementById('status-text');

    try {
        // PASSO 1: Solicitar URL Assinada ao Django
        statusText.innerText = "üîë Autorizando com AWS...";
        const response = await fetch(`/api/get-presigned-url/?file_name=${encodeURIComponent(file.name)}&file_type=${file.type}`);
        const data = await response.json();

        // PASSO 2: Montar o FormData para o S3
        const formData = new FormData();
        Object.entries(data.fields).forEach(([key, value]) => {
            formData.append(key, value);
        });
        formData.append("file", file);

        // PASSO 3: Upload via XMLHttpRequest (para monitorar progresso)
        const xhr = new XMLHttpRequest();
        xhr.open("POST", data.url, true);

        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percent + '%';
                progressBar.innerText = percent + '%';
                statusText.innerText = `üì§ Enviando arquivo: ${percent}%`;
            }
        };

        xhr.onload = async () => {
            if (xhr.status === 204 || xhr.status === 200) {
                statusText.innerText = "‚úÖ S3 recebeu! Finalizando registro no banco...";
                
                // PASSO 4: Avisar o Django para salvar o modelo Video
                const confirmResp = await fetch('/api/confirm-upload/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `file_name=${encodeURIComponent(file.name)}&titulo=${encodeURIComponent(tituloInput.value)}`
                });

                if (confirmResp.ok) {
                    statusText.innerText = "üöÄ Tudo pronto! Upload conclu√≠do com sucesso!";
                    // Adiciona o v√≠deo na tabela de hist√≥rico da sess√£o
                    const tbody = document.getElementById('recent-uploads');
                    const now = new Date().toLocaleTimeString();
                    
                    // Remove a mensagem de "Nenhum upload" se for o primeiro
                    if (tbody.innerHTML.includes("Nenhum upload")) tbody.innerHTML = "";

                    const newRow = `<tr>
                        <td>${tituloInput.value}</td>
                        <td>${now}</td>
                        <td><span class="badge bg-success">Salvo no Banco</span></td>
                    </tr>`;
                    tbody.innerHTML = newRow + tbody.innerHTML; // Adiciona no topo da lista
                    setTimeout(() => {
                        // 1. Limpa os inputs
                        document.getElementById('video-file').value = "";
                        document.getElementById('titulo-id').value = "";
                        
                        // 2. Reseta e esconde a barra de progresso
                        document.getElementById('progress-container').style.display = 'none';
                        document.getElementById('upload-progress').style.width = '0%';
                        document.getElementById('upload-progress').innerText = '0%';
                        
                        // 3. Reativa o bot√£o de upload
                        btn.disabled = false;
                        
                        alert("V√≠deo registrado! Voc√™ j√° pode subir o pr√≥ximo.");
                    }, 2000); // Aguarda 2 segundos para o usu√°rio ler a mensagem de sucesso
                }
            } else {
                alert("Erro ao enviar para o S3. Verifique o CORS.");
                btn.disabled = false;
            }
        };

        xhr.send(formData);

    } catch (error) {
        console.error(error);
        alert("Erro na conex√£o.");
        btn.disabled = false;
    }
}
</script>
{% endblock %}