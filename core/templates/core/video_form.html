{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">Upload de V√≠deo (Direct to S3)</h3>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="titulo-id" class="form-label fw-bold">T√≠tulo do V√≠deo</label>
                <input type="text" id="titulo-id" class="form-control" placeholder="Ex: Aula 01 - Introdu√ß√£o">
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Curso</label>
                    <select id="curso-id" class="form-select" onchange="carregarModulos(this.value)">
                        <option value="">Selecione um curso...</option>
                        {% for course in courses %}
                            <option value="{{ course.id }}">{{ course.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">M√≥dulo</label>
                    <select id="modulo-id" class="form-select" disabled>
                        <option value="">Selecione o curso primeiro...</option>
                    </select>
                </div>
            </div>

            <div class="mb-3">
                <label for="video-file" class="form-label fw-bold">Selecione o arquivo MP4</label>
                <input type="file" id="video-file" class="form-control" accept="video/mp4,video/x-m4v,video/*">
            </div>

            <button type="button" id="upload-btn" onclick="startDirectUpload()" class="btn btn-success w-100 fw-bold">
                Fazer Upload
            </button>

            <div id="progress-container" class="mt-4" style="display:none;">
                <div class="progress" style="height: 25px;">
                    <div id="upload-progress" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%;">0%</div>
                </div>
                <p id="status-text" class="text-center mt-2 fw-bold text-primary">Iniciando...</p>
            </div>

            <hr class="my-5">

            <h4>√öltimos Uploads Realizados</h4>
            <table class="table table-striped mt-3">
                <thead>
                    <tr>
                        <th>T√≠tulo</th>
                        <th>Data</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="recent-uploads">
                    <tr><td colspan="3" class="text-center text-muted">Nenhum upload nesta sess√£o.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// 1. Carregar m√≥dulos dinamicamente
async function carregarModulos(courseId) {
    const moduloSelect = document.getElementById('modulo-id');
    if (!courseId) {
        moduloSelect.disabled = true;
        moduloSelect.innerHTML = '<option value="">Selecione o curso primeiro...</option>';
        return;
    }

    try {
        const response = await fetch(`/api/get-modules/${courseId}/`);
        const modulos = await response.json();

        moduloSelect.innerHTML = '<option value="">Selecione o m√≥dulo...</option>';
        modulos.forEach(m => {
            moduloSelect.innerHTML += `<option value="${m.id}">${m.title}</option>`;
        });
        moduloSelect.disabled = false;
    } catch (error) {
        console.error("Erro ao carregar m√≥dulos:", error);
    }
}

// 2. Fun√ß√£o principal de Upload
async function startDirectUpload() {
    const fileInput = document.getElementById('video-file');
    const tituloInput = document.getElementById('titulo-id');
    const moduloInput = document.getElementById('modulo-id'); 
    const file = fileInput.files[0];
    const btn = document.getElementById('upload-btn');

    // Valida√ß√£o corrigida dentro da fun√ß√£o
    if (!file || !tituloInput.value || !moduloInput.value) {
        return alert("Por favor, preencha T√≠tulo, Curso, M√≥dulo e selecione um arquivo!");
    }

    btn.disabled = true;
    document.getElementById('progress-container').style.display = 'block';
    const progressBar = document.getElementById('upload-progress');
    const statusText = document.getElementById('status-text');

    try {
        statusText.innerText = "üîë Autorizando com AWS...";
        const response = await fetch(`/api/get-presigned-url/?file_name=${encodeURIComponent(file.name)}&file_type=${file.type}`);
        const data = await response.json();

        const formData = new FormData();
        Object.entries(data.fields).forEach(([key, value]) => {
            formData.append(key, value);
        });
        formData.append("file", file);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", data.url, true);

        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percent + '%';
                progressBar.innerText = percent + '%';
                statusText.innerText = `üì§ Enviando arquivo: ${percent}%`;
            }
        };

        xhr.onload = async () => {
            if (xhr.status === 204 || xhr.status === 200) {
                statusText.innerText = "‚úÖ S3 recebeu! Finalizando registro no banco...";
                
                const confirmResp = await fetch('/api/confirm-upload/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `file_name=${encodeURIComponent(file.name)}&titulo=${encodeURIComponent(tituloInput.value)}&modulo_id=${moduloInput.value}`
                });

                if (confirmResp.ok) {
                    statusText.innerText = "üöÄ Tudo pronto! Upload conclu√≠do com sucesso!";
                    
                    const tbody = document.getElementById('recent-uploads');
                    const now = new Date().toLocaleTimeString();
                    if (tbody.innerHTML.includes("Nenhum upload")) tbody.innerHTML = "";

                    const newRow = `<tr>
                        <td>${tituloInput.value}</td>
                        <td>${now}</td>
                        <td><span class="badge bg-success">Salvo no Banco</span></td>
                    </tr>`;
                    tbody.innerHTML = newRow + tbody.innerHTML;

                    setTimeout(() => {
                        fileInput.value = "";
                        tituloInput.value = "";
                        document.getElementById('curso-id').value = "";
                        moduloInput.innerHTML = '<option value="">Selecione o curso primeiro...</option>';
                        moduloInput.disabled = true;
                        document.getElementById('progress-container').style.display = 'none';
                        progressBar.style.width = '0%';
                        btn.disabled = false;
                        alert("V√≠deo registrado com sucesso!");
                    }, 2000);
                }
            } else {
                alert("Erro ao enviar para o S3. Verifique o CORS.");
                btn.disabled = false;
            }
        };
        xhr.send(formData);

    } catch (error) {
        console.error(error);
        alert("Erro na conex√£o.");
        btn.disabled = false;
    }
}
</script>
{% endblock %}